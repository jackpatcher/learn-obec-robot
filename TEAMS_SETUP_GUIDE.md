# คู่มือการติดตั้งและใช้งานระบบตั้งค่าทีมระดับกลาง (อัพเดต v2)

## ภาพรวมระบบ

ระบบนี้ช่วยให้คุณสามารถ:
- **เพิ่มข้อมูลทีม**แข่งขันหุ่นยนต์ระดับกลาง
- **กรอกคะแนน** 2 รอบพร้อมจำนวน retry และเวลา
- **ดูผลการแข่งขัน**ในรูปแบบกราฟและตาราง
- **ยืนยันตัวตน**ก่อนเพิ่มทีมหรือกรอกคะแนน (รหัสผ่านแก้ไขได้ใน Google Sheets)

ข้อมูลจะบันทึกลง Google Sheets อัตโนมัติผ่าน Google Apps Script

## โครงสร้างข้อมูลใน Google Sheets

### ชีท "ข้อมูล"
| school_id | โรงเรียน | เขต | ระดับ | รายการแข่ง | สนาม | # score1 | # retry1 | time1 | # score2 | # retry2 | time2 | timestamp |
|-----------|---------|-----|-------|-----------|------|----------|----------|-------|----------|----------|-------|-----------|
| s001 | สมศุภนาการวิทยา | 4 | ม.ปลาย | สพม.นศ68 | A | 0 | 3 | 3:00:00 | 15 | 0 | 3:00:00 | 2025-01-08... |

### ชีท "การตั้งค่า"
| A | B |
|---|---|
| abcd | ← รหัสผ่านสำหรับยืนยันตัวตน (แก้ไขได้) |

## ฟีเจอร์ใหม่

### 1. ระบบยืนยันตัวตน
- ก่อนเพิ่มทีมหรือกรอกคะแนน ต้องยืนยันตัวตนก่อน
- รหัสผ่านเริ่มต้น: **abcd**
- สามารถแก้ไขรหัสผ่านได้ในชีท "การตั้งค่า" ช่อง A1

### 2. ตารางกรอกคะแนน
- กรอกคะแนน 2 รอบ (score1, score2)
- บันทึกจำนวนครั้งที่ retry (retry1, retry2)
- บันทึกเวลาที่ใช้ (time1, time2)
- ระบบจะเลือกค่าที่ดีที่สุดมาแสดงอัตโนมัติ

### 3. หน้าผลการแข่งขัน
- แสดงกราฟแท่ง (Bar Chart) แบบ horizontal
- เรียงลำดับตามคะแนน > retry > เวลา
- แสดงตารางรายละเอียดพร้อมอันดับ
- ดูได้ทุกคน ไม่ต้องยืนยันตัวตน

## ขั้นตอนการติดตั้ง Google Apps Script

### 1. สร้าง Google Sheets

1. เปิด Google Drive
2. สร้าง Google Sheets ใหม่
3. ตั้งชื่อว่า "ข้อมูลทีมแข่งขันหุ่นยนต์" หรือชื่ออื่นที่ต้องการ

### 2. เปิด Apps Script Editor

1. ในไฟล์ Google Sheets ที่สร้างไว้
2. ไปที่เมนู **Extensions** > **Apps Script**
3. จะเปิดหน้าต่างใหม่เป็น Apps Script Editor

### 3. วางโค้ด Apps Script

1. ลบโค้ดเดิมทั้งหมดในไฟล์ `Code.gs`
2. คัดลอกโค้ดจากไฟล์ `appscript.js` ทั้งหมด
3. วางลงในไฟล์ `Code.gs`
4. กด **Ctrl+S** (หรือ **Cmd+S** บน Mac) เพื่อบันทึก
5. ตั้งชื่อโปรเจคว่า "ระบบจัดการทีมหุ่นยนต์" หรือชื่ออื่นที่ต้องการ

### 4. สร้างชีทการตั้งค่า (สำคัญ!)

1. กลับไปที่ Google Sheets
2. สร้างชีทใหม่ชื่อ **"การตั้งค่า"**
3. ใส่รหัสผ่านที่ช่อง A1 (เช่น "abcd")
4. ใส่คำอธิบายที่ช่อง B1: "← รหัสผ่านสำหรับยืนยันตัวตน (แก้ไขได้)"

**หมายเหตุ**: ถ้าไม่สร้างชีทนี้ ระบบจะสร้างให้อัตโนมัติเมื่อมีการเรียกใช้ครั้งแรก

### 5. Deploy Web App

1. คลิกปุ่ม **Deploy** > **New deployment**
2. คลิกไอคอนเฟือง (⚙️) ข้าง "Select type"
3. เลือก **Web app**
4. ตั้งค่าดังนี้:
   - **Description**: "API สำหรับบันทึกข้อมูลทีม"
   - **Execute as**: Me (your-email@gmail.com)
   - **Who has access**: Anyone
5. คลิก **Deploy**
6. ระบบจะขออนุญาตในการเข้าถึง Google Sheets
   - คลิก **Authorize access**
   - เลือกบัญชี Google ของคุณ
   - คลิก **Advanced** > **Go to [ชื่อโปรเจค] (unsafe)**
   - คลิก **Allow**
7. คัดลอก **Web app URL** ที่ได้
   - URL จะมีรูปแบบประมาณ: `https://script.google.com/macros/s/AKfycby.../exec`

### 5. ตั้งค่า URL ในไฟล์ HTML

1. เปิดไฟล์ `midhigh.html`
2. ค้นหาคำว่า `YOUR_GOOGLE_APPS_SCRIPT_URL_HERE`
3. แทนที่ด้วย URL ที่คัดลอกมาในขั้นตอนที่ 4
4. บันทึกไฟล์

ตัวอย่าง:
```javascript
// ก่อนแก้ไข
gasUrl: 'YOUR_GOOGLE_APPS_SCRIPT_URL_HERE'

// หลังแก้ไข
gasUrl: 'https://script.google.com/macros/s/AKfycby.../exec'
```

## วิธีการใช้งาน

### การยืนยันตัวตน

1. เปิดหน้า **ระดับกลาง** > **ตั้งค่าทีม**
2. คลิกปุ่ม **ยืนยันตัวตน**
3. กรอกรหัสผ่าน (ค่าเริ่มต้น: abcd)
4. คลิก **ยืนยัน**
5. เมื่อยืนยันตัวตนสำเร็จ จะสามารถเพิ่มทีมและกรอกคะแนนได้

### เพิ่มทีมใหม่

**ต้องยืนยันตัวตนก่อน**

1. คลิกปุ่ม **เพิ่มทีม**
2. กรอกข้อมูลในฟอร์ม:
   - **รหัสโรงเรียน**: เช่น s001
   - **โรงเรียน**: ชื่อโรงเรียน
   - **เขต**: เขตพื้นที่การศึกษา
   - **ระดับ**: ม.ปลาย (default)
   - **รายการแข่ง**: เช่น สพม.นศ68
   - **สนาม**: เลือก A, B, C, หรือ D
3. คลิก **บันทึก**
4. ระบบจะส่งข้อมูลไปบันทึกใน Google Sheets อัตโนมัติ

### กรอกคะแนน

**ต้องยืนยันตัวตนก่อน**

1. หลังจากเพิ่มทีมแล้ว จะเห็นตารางแสดงรายชื่อทีม
2. กรอกคะแนนในช่องต่างๆ:
   - **# score1**: คะแนนรอบที่ 1 (0-100)
   - **# retry1**: จำนวนครั้งที่ retry รอบที่ 1
   - **time1**: เวลาที่ใช้รอบที่ 1 (เช่น 0:43:84)
   - **# score2**: คะแนนรอบที่ 2 (0-100)
   - **# retry2**: จำนวนครั้งที่ retry รอบที่ 2
   - **time2**: เวลาที่ใช้รอบที่ 2 (เช่น 0:44:27)
3. คลิกปุ่ม **บันทึก** ในแถวนั้นๆ
4. ระบบจะอัพเดตข้อมูลใน Google Sheets

**หมายเหตุ**: 
- คอลัมน์ **score**, **retry**, **time** จะแสดงค่าที่ดีที่สุดอัตโนมัติ
- ระบบเลือกรอบที่มีคะแนนสูงกว่า
- ถ้าคะแนนเท่ากัน จะเลือกรอบที่มี retry น้อยกว่า
- ถ้า retry เท่ากัน จะเลือกรอบที่ใช้เวลาน้อยกว่า

### โหลดข้อมูลจาก Google Sheets

1. คลิกปุ่ม **โหลดข้อมูลจาก Google Sheets**
2. ระบบจะดึงข้อมูลทีมทั้งหมดจาก Google Sheets มาแสดง
3. ใช้เมื่อต้องการ refresh ข้อมูล หรือเมื่อเปิดหน้าครั้งแรก

### ดูผลการแข่งขัน

**ไม่ต้องยืนยันตัวตน**

1. ไปที่ **ระดับกลาง** > **ผลการแข่งขัน**
2. จะเห็น:
   - **กราฟแท่ง** แสดงคะแนนของแต่ละทีมเรียงจากสูงไปต่ำ
   - **ตารางรายละเอียด** แสดงอันดับ คะแนน retry เวลา
3. คลิก **โหลดข้อมูล** เพื่อ refresh ข้อมูล

### ออกจากระบบ

1. คลิกปุ่ม **ออกจากระบบ** ที่มุมขวาบน
2. ระบบจะกลับไปสู่โหมดดูอย่างเดียว (Read-only)

## การทำงานของระบบ

### ขั้นตอนการส่งข้อมูล

1. **Frontend (midhigh.html)**:
   - ผู้ใช้ยืนยันตัวตนด้วยรหัสผ่าน
   - กรอกข้อมูลทีมหรือคะแนนในฟอร์ม
   - ตรวจสอบความถูกต้องของข้อมูล
   - ส่งข้อมูลผ่าน JSONP GET request ไปยัง Google Apps Script

2. **Google Apps Script**:
   - รับข้อมูลผ่าน `doGet()` function
   - ตรวจสอบ action (addTeam, updateScore, getAllTeams, getPassword)
   - ดำเนินการตาม action
   - บันทึกข้อมูลลง Google Sheets
   - ส่ง response กลับมาเป็น JSONP

3. **Response**:
   - แสดงสถานะการบันทึกบนหน้าเว็บ
   - หากสำเร็จจะอัพเดตข้อมูลในตารางแสดงผล

### Actions ที่รองรับ

1. **addTeam**: เพิ่มทีมใหม่
2. **updateScore**: อัพเดตคะแนนทีม
3. **getAllTeams**: ดึงข้อมูลทีมทั้งหมด
4. **getPassword**: ดึงรหัสผ่านจากชีทการตั้งค่า

## โครงสร้างข้อมูลที่ส่ง

### เพิ่มทีม (addTeam)
```javascript
{
  action: "addTeam",
  school_id: "s001",
  school_name: "สมศุภนาการวิทยา",
  zone: "4",
  level: "ม.ปลาย",
  competition: "สพม.นศ68",
  field: "A",
  timestamp: "2025-01-08T10:30:00.000Z"
}
```

### อัพเดตคะแนน (updateScore)
```javascript
{
  action: "updateScore",
  school_id: "s001",
  score1: 100,
  retry1: 0,
  time1: "0:43:84",
  score2: 75,
  retry2: 0,
  time2: "1:00:00"
}
```

### ดึงข้อมูลทั้งหมด (getAllTeams)
```javascript
{
  action: "getAllTeams"
}
```

### ดึงรหัสผ่าน (getPassword)
```javascript
{
  action: "getPassword"
}
```

## การอัพเดตข้อมูล

หากต้องการอัพเดตโค้ด Apps Script:

1. เปิด Apps Script Editor
2. แก้ไขโค้ดตามต้องการ
3. บันทึกไฟล์
4. ไปที่ **Deploy** > **Manage deployments**
5. คลิกไอคอนดินสอ (✏️) ที่ deployment ที่ใช้งานอยู่
6. เปลี่ยน **Version** เป็น "New version"
7. คลิก **Deploy**

**หมายเหตุ**: URL จะยังคงเหมือนเดิม ไม่ต้องเปลี่ยนในไฟล์ HTML

## การแก้ไขปัญหา

### ข้อผิดพลาด: "รหัสผ่านไม่ถูกต้อง"

**สาเหตุ**:
- รหัสผ่านที่กรอกไม่ตรงกับที่ตั้งไว้ใน Google Sheets

**วิธีแก้**:
1. เปิด Google Sheets
2. ไปที่ชีท "การตั้งค่า"
3. ดูรหัสผ่านที่ช่อง A1
4. ลองใช้รหัสผ่านนั้น หรือแก้ไขเป็นรหัสใหม่

### ข้อผิดพลาด: "JSONP request failed"

**สาเหตุ**:
- URL ของ Apps Script ไม่ถูกต้อง
- ไม่มีการ Deploy Web App
- การตั้งค่า "Who has access" ไม่ใช่ "Anyone"

**วิธีแก้**:
1. ตรวจสอบ URL ว่าถูกต้อง
2. ตรวจสอบว่า Deploy เป็น Web App แล้ว
3. ตรวจสอบการตั้งค่า access

### ข้อผิดพลาด: "Request timeout"

**สาเหตุ**:
- Google Apps Script ทำงานช้า
- เครือข่ายมีปัญหา

**วิธีแก้**:
1. ลองบันทึกอีกครั้ง
2. ตรวจสอบการเชื่อมต่ออินเทอร์เน็ต

### ข้อผิดพลาด: "รหัสโรงเรียนนี้มีอยู่แล้วในระบบ"

**สาเหตุ**:
- มีข้อมูลทีมนี้อยู่ใน Google Sheets แล้ว

**วิธีแก้**:
1. เปลี่ยนรหัสโรงเรียนใหม่
2. หรือลบข้อมูลเก่าใน Google Sheets

### ไม่สามารถกรอกคะแนนได้

**สาเหตุ**:
- ยังไม่ได้ยืนยันตัวตน

**วิธีแก้**:
1. คลิกปุ่ม "ยืนยันตัวตน"
2. กรอกรหัสผ่านที่ถูกต้อง
3. คลิก "ยืนยัน"

### ข้อมูลไม่แสดงในหน้าผลการแข่งขัน

**สาเหตุ**:
- ยังไม่ได้โหลดข้อมูลจาก Google Sheets

**วิธีแก้**:
1. คลิกปุ่ม "โหลดข้อมูล"
2. รอสักครู่ให้ระบบดึงข้อมูล

## ความปลอดภัย

### การรักษาความปลอดภัยของข้อมูล

1. **Google Apps Script**:
   - ตั้งค่า "Execute as: Me" - ทำให้ script ทำงานด้วยสิทธิ์ของเจ้าของ
   - ตั้งค่า "Who has access: Anyone" - ช่วยให้ส่งข้อมูลได้โดยไม่ต้อง login

2. **การตรวจสอบข้อมูล**:
   - ตรวจสอบข้อมูลซ้ำโดยใช้ school_id
   - ตรวจสอบความถูกต้องของข้อมูลก่อนบันทึก

3. **ข้อแนะนำ**:
   - อย่าแชร์ URL ของ Apps Script ในที่สาธารณะมากเกินไป
   - ใช้รหัสผ่านที่แข็งแรงกว่า "abcd" สำหรับการใช้งานจริง
   - สามารถเปลี่ยนรหัสผ่านได้ตลอดเวลาในชีท "การตั้งค่า"

## สรุป

ระบบนี้ช่วยให้การจัดการข้อมูลทีมแข่งขันสะดวกและรวดเร็วขึ้น โดยใช้:
- **Vue.js + Vuetify** สำหรับ UI
- **JSONP** สำหรับการสื่อสารแบบ cross-origin
- **Google Apps Script** สำหรับ backend
- **Google Sheets** สำหรับเก็บข้อมูล

### ฟีเจอร์หลัก
✅ ระบบยืนยันตัวตน (รหัสผ่านแก้ไขได้)  
✅ เพิ่มทีมแข่งขัน  
✅ กรอกคะแนน 2 รอบพร้อม retry และเวลา  
✅ เลือกค่าที่ดีที่สุดมาแสดงอัตโนมัติ  
✅ แสดงผลการแข่งขันเป็นกราฟและตาราง  
✅ เรียงลำดับตามคะแนน > retry > เวลา  
✅ โหมดดูอย่างเดียวสำหรับผู้ชม  
✅ โหลดข้อมูลจาก Google Sheets แบบ real-time  

หากมีคำถามหรือปัญหาการใช้งาน สามารถตรวจสอบ Console ของเบราว์เซอร์ (F12) เพื่อดู error message ได้
